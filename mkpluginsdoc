#!/bin/bash

set -euo pipefail

cat <<'HEAD'
# Plugins

This file is generated by the [mkpluginsdoc](mkpluginsdoc) command, which
processes the list of repositories configured in [.mrconfig](.mrconfig).

| Name | Description | Current Branch | Last Updated |
| ---- | ----------- | -------------- | ------------ |
HEAD

while read -r url name; do
    path="pack/plugins/start/${name}"
    json="$(gh repo view --json name,description,url "$url")"

    branch="$(git -C "$path" rev-parse --abbrev-ref HEAD)"
    read -r commit updated <<<"$(git -C "$path" log -1 --format='%H %cr')"

    printf '| [%s](%s) ' "$(jq -r '.name' <<<"$json")" "$(jq -r '.url' <<<"$json")"
    printf '| %s ' "$(jq -r '.description' <<<"$json" | sed -e 's/|/\\|/')"
    printf '| [%s](%s/tree/%s) ' "$branch" "$(jq -r '.url' <<<"$json")" "$branch"
    printf '| [%s](%s/commit/%s) ' "$updated" "$(jq -r '.url' <<<"$json")" "$commit"
    printf '|\n'
done < <(awk '($1 == "checkout") { print $5, $6 }' .mrconfig | sed -e "s/'//g" | sort -k2)
