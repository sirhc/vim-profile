#!/usr/bin/env zsh

set -euo pipefail

cat <<'HEAD'
# Plugins

This file is generated by the [mkpluginsdoc](mkpluginsdoc) command, which processes the list of repositories configured in [.mrconfig](.mrconfig).

HEAD

get_data() {
    print 'Ref,Hash,Age,Name,Description,URL'

    mr -j8 run command zsh -c '
        print -n "\"$( git rev-parse --abbrev-ref HEAD )\","
        print -n "\"$( git log -1 --format=%H )\","
        print -n "\"$( git log -1 --format=%cs )\","
        gh repo view --json name,description,url --jq "[.name, .description, .url] | @csv"
    ' | sed -e '/^$/d' -e '/^mr run:/d'
}

filter_data() {
    csvsql --table Repos --query '
        SELECT
            printf("[%s](%s)", Name, URL) AS Name,
            Description,
            printf("[%s](%s/tree/%s)", Ref, URL, Ref) AS Branch,
            printf("[%s](%s/commit/%s)", Age, URL, Hash) AS [Last Updated]
        FROM Repos
        ORDER BY Name ASC
    '
}

get_data | filter_data | csvlook
